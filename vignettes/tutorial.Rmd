---
title: "BiomassWorkflow Package Tutorial"
author: "Eduardo Contijoch"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{Raw Data Processing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r Dependencies, include=FALSE}
library(pander)
library(BiomassWorkflow)
library(magrittr)
```
## Getting Set Up

This document is meant to serve as an introductory primer for using R to streamline and standardize the generation and analysis of microbial density data. 

To follow along, you will need to download and load the package (I'm also loading the magrittr package to make the code more readable with pipes:
```{r Setup, eval=FALSE, message=FALSE, warning=FALSE, include=TRUE, results='hide'}
# Install and load the devtools package to help download the BiomassWorkflow package
install.packages('devtools', repos='http://cran.us.r-project.org')
require(devtools)

# Install and load the BiomassWorkflow package
devtools::install_bitbucket('econtijoch/biomass-workflow')
require(BiomassWorkflow)
require(magrittr)
```

Now you should be able to get working. If those instructions cause any errors or warnings, the best way to overcome them is to use google to search for answers - links to stackoverflow.com are always a good place to start.

### Sample Data
If you don't have data ready to work with, you can use the example data that comes with the package to get started or to model your work. This can be done with the `sample_file_maker()` function. Briefly, it will download example raw files for use with this (and other) tutorials. You can specify a directory to write the output into.

```{r SampleData, eval = T, echo=TRUE, message=FALSE, warning=FALSE, results = 'hide', include = TRUE}
# Get and store path to working directory
working_directory <- getwd()
# Generate sample files to this directory
sample_file_maker(directory = working_directory)
```



This will create several files in your directory:

* ***Sample_BR_Standards_Mapping.csv*** - A mapping file for the Broad-Range standards, which were included on the same plate as the High-Sensitivity standards, but a different plate than the samples.
* ***Sample_HS_Standards_Mapping.csv*** - A mapping file for the High-Sensitivity standards, which were included on the same plate as the Broad-Range standards, but a different plate than the samples.
* ***Sample_Mapping*** - A mapping file that can be used directly in the DataAnalysis function (see below)
* ***Sample_SampleInfo.csv*** - A file containing information about the samples, that can be used to make a mapping file from scratch
* ***Sample_Tube_Order_Scanned*** - A file of tube locations from the Cho Lab Matrix 96-barcode scanner
* ***Sample_BR_raw.xls*** - An excel file from the plate-reader for the sample plate run with the Broad-Range Dye
* ***Sample_HS_raw.xls*** - An excel file from the plate-reader for the sample plate run with the High-Sensitivity Dye
* ***Sample_Standards_raw.xls*** - An excel file from the plate-reader for the standards plate (contains both BR and HS standards)
* ***Sample_Empty_Weights.txt*** - A text file containing the empty weight information for the tubes. Contains the BarcodeID's (from the LabelMaker Spreadsheet), tube barcode (from bottom of matrix tubes), which will both be helpful in constructing a mapping file.
* ***Sample_Full_Weights.txt*** - A text file containing the full weight information for the tubes. Contains the tube barcode (from bottom of matrix tubes), which will both be helpful in constructing a mapping file by tying this data back with the empty weights.

For this example, 96 samples were processed with the DNase Inactivation Buffer extraction protocol in the Matrix tubes (1 mL). 200 uL of the cell lysate was used for the DNA isolation (200 of 700 uL total, so the scaling factor here is 3.5x). The samples were measured with both the Broad Range and High Sensitivity qubit dyes with 2 uL of sample in 198 uL of buffer, and standards were measured using 10 uL of standard in 190 uL of buffer.

## Prep - Calculating Sample Masses
Now that we have data to work with, we can put this package to work.

The first step in this analysis is to calculate sample masses from the weight data of our empty and full tubes. Additionally, we can optionally use the order of the tubes from the 96-well plate scanner to align the tubes in the order used in the extraction.

The function `mass_and_order()` takes care of both of these functions:

```{r mass_and_order, eval=T, fig.path='figure/', message=FALSE, warning=FALSE, include=T, messages=F, results='markup'}

sample_masses <- mass_and_order('Sample_Empty_Weights.txt', 'Sample_Full_Weights.txt', order = 'Sample_Tube_Order_Scanned.csv')


head(sample_masses)
```

# Prep - Mapping file

We can use this data to manually create a mapping file (by saving this output as a .csv file, and then manipulating it with excel - making sure to save the result as a .csv file!), or we can do much of that work in R, to leverage some of the data processing capabilities of R.

It is important to remember that a valid mapping file has a few NECESSARY columns:

* **ReaderWell** - This is necessary to be able to connect the data from the plate reader to the data in your mapping file. The ReaderWell column contains which well a sample came from, and it is important that the wells be in 2-digit format (e.g. A01 and not A1).
* **Type** - This column designates the type of sample in the well. This is either going to be "Experiment" or "Standard" to designate an experimental sample or a standard, respectively.
* **SampleMass** - This is necessary for the calculation of microbial density in your experimental samples. If you need to just get a DNA concentration, you can put any placeholder here (suggested placeholder is 1). For Standard samples, the SampleMass column is where you include the standard value. For HS dye, this will be \{0, 5, 10, 20, 40, 60, 80, 100\}, and for the BR dye, this will be \{0, 50, 100, 200, 400, 600, 800, 1000\} (this assumes 10 uL of standard was loaded into the plate)
* **BarcodeID** - This is a unique identifier for the sample. This is typically taken from the BarcodeID generated from the LabelMaker spreadsheet, but it is not necessary for it to be. If you don't want to spend much time making unique sample identifiers, you can simply use \{Sample001, Sample002, Sample003, ...\}

The `mass_and_order()` function will already give us a table with the BarcodeID and the SampleMass, so all we need to do is add a couple of columns, and join this data with some information about the specific samples, and we should have a complete mapping file.

Lets take a look at what's in the example file called *Sample_SampleInfo.csv*:

```{r sample_info, echo=TRUE, message=FALSE, warning=FALSE}

sample_info <- readr::read_csv('Sample_SampleInfo.csv')

head(sample_info)

```

That looks like it'll help put together a good mapping file, so let's start building it:

```{r mapping_file, echo=TRUE, message=FALSE, warning=FALSE}

mapping_file <- dplyr::left_join(sample_masses, sample_info) %>% 
  dplyr::mutate(Type = "Experiment", ReaderWell = SampleWell) %>% 
  dplyr::select(ReaderWell, Type, BarcodeID, SampleMass, everything())

head(mapping_file)


```


# Final Data Analysis
The main function to perform analyses will be `DataAnalysis()`. It reads in your raw data and mapping file and produes a table that will contain a host of useful data for downstream applications. These include:

* DNA concentration - we construct a standard curve based on the given standard samples and values, and use this to compute DNA concnetrations for each sample
* Microbial Density - using the DNA concentration, our scaling factors and sample mass, we compute the sample biomass (ug DNA per mg sample). 
* 16S PCR prep - Identifies if there is enough DNA for performing 16S sequencing, and computes the DNA and water volumes necessary to acheive a dilution to 2 ng/uL (the working conentration of template for the PCR reaction).
* Metagenomics prep - Identifies if there is enough DNA for performing metagenomic shotgun sequencing, and computes the DNA and water volumes necessary to acheive a dilution to 20 ng/uL (into 25 uL -- 20 uL is needed for the metagenomics library prep protocol).


